<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitSyle - Inicio</title>

    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#014421">

    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <!-- Link al archivo CSS externo -->
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Alertas normales (login, etc) Arriba -->
    <div id="alert-container" class="position-fixed top-0 start-50 translate-middle-x p-3"
        style="z-index: 2050; width: 90%; max-width: 400px;"></div>

    <div id="offline-indicator"
        class="position-fixed bottom-0 start-0 m-3 p-2 bg-danger text-white rounded shadow d-none"
        style="z-index: 3000;">
        <i class="bi bi-wifi-off"></i> Modo Offline
    </div>

    <!-- NUEVO: Contenedor para alerta moderna de stock (Abajo Centro) -->
    <div id="toast-container" class="position-fixed bottom-0 start-50 translate-middle-x" style="z-index: 3050; margin-bottom: 80px; width: auto; max-width: 95%;"></div>

    <!-- Navbar -->
    <nav class="navbar navbar-main sticky-top">
        <div class="container-fluid d-flex align-items-center position-relative">

            <!-- LOGO -->
            <a class="navbar-brand d-flex align-items-center me-auto" href="index.html">
                <img src="Img/logo.png" alt="FitSyle" onerror="this.src='https://via.placeholder.com/35?text=F'">
                <span class="navbar-brand-text ms-2 d-none d-sm-inline">FitSyle</span>
            </a>

            <!-- BUSCADOR -->
            <div class="search-container mx-2">
                <div class="search-input-wrapper">
                    <i class="bi bi-search search-icon"></i>
                    <!-- Placeholder "Buscar" -->
                    <input type="text" id="searchInput" class="search-input" placeholder="Buscar">
                    <i class="bi bi-x search-clear-icon d-none" id="clearSearchBtn"></i>
                </div>
            </div>

            <!-- ICONOS (Login/Carrito) SIEMPRE VISIBLES -->
            <div class="d-flex align-items-center gap-2 order-lg-last ms-2 mobile-icons-group">

                <!-- CARRITO -->
                <a class="btn btn-icon fs-4 text-white position-relative d-flex align-items-center" href="#"
                    data-bs-toggle="offcanvas" data-bs-target="#cartOffcanvas">
                    <i class="bi bi-cart3"></i>
                    <span class="cart-text-mobile d-none">Carrito</span>
                    <span class="cart-badge d-none" id="cart-badge">0</span>
                </a>

                <!-- USUARIO / LOGIN -->
                <div class="d-flex align-items-center">
                    <!-- BOT√ìN LOGIN (VISIBLE CUANDO NO HAY SESI√ìN) -->
                    <a class="btn btn-icon fs-4 text-white d-flex align-items-center" href="#" id="loginBtn"
                        data-bs-toggle="modal" data-bs-target="#loginModal">
                        <i class="bi bi-person-circle"></i>
                    </a>

                    <!-- DROPDOWN USUARIO (VISIBLE CON SESI√ìN) -->
                    <div class="dropdown d-none" id="userDropdown">
                        <!-- Nombre pegado al menu hamburguesa en m√≥vil -->
                        <a class="btn btn-icon text-white d-flex align-items-center dropdown-toggle pe-1" href="#"
                            role="button" data-bs-toggle="dropdown" aria-expanded="false"
                            style="text-decoration: none;">
                            <i class="bi bi-person-circle fs-4"></i>
                            <span id="navUserName" class="ms-1 fs-6 fw-bold d-inline-block" style="vertical-align: middle;">Usuario</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-user">
                            <li>
                                <button class="dropdown-item text-danger d-flex align-items-center gap-2 justify-content-center"
                                    id="logoutBtn">
                                    <i class="bi bi-box-arrow-right"></i> Cerrar Sesi√≥n
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- HAMBURGUESA (Un poco m√°s grande en CSS) -->
                <button class="navbar-toggler ms-1 d-block" type="button" id="menuToggleBtn">
                    <i class="bi bi-list text-white"></i>
                </button>
            </div>

        </div>
    </nav>

    <!-- Banner -->
    <section class="carousel-icon-wrapper">
        <div id="heroCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-indicators">
                <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="0" class="active"></button>
                <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="1"></button>
                <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="2"></button>
            </div>
            <div class="carousel-inner">
                <div class="carousel-item active"><img src="img/pwa-01.png" alt="Banner 1" onerror="this.src='https://via.placeholder.com/1200x400?text=Banner+FitSyle+1'"></div>
                <div class="carousel-item"><img src="img/pwa2-01.png" alt="Banner 2" onerror="this.src='https://via.placeholder.com/1200x400?text=Banner+FitSyle+2'"></div>
                <div class="carousel-item"><img src="Img/banner1.png" alt="Banner 3" onerror="this.src='https://via.placeholder.com/1200x400?text=Banner+FitSyle+3'"></div>
            </div>

            <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
                <div class="carousel-control-icon-bg"><i class="bi bi-chevron-left"></i></div>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
                <div class="carousel-control-icon-bg"><i class="bi bi-chevron-right"></i></div>
            </button>
        </div>

        <div class="features-overlay">
            <div class="rounded-pill-custom">
                <div class="row g-2 justify-content-center">
                    <div class="col-3 icon-feature">
                        <div class="icon-circle shadow-sm"><i class="bi bi-percent"></i></div>
                        <h5>DESCUENTOS</h5>
                    </div>
                    <div class="col-3 icon-feature">
                        <div class="icon-circle shadow-sm"><i class="bi bi-truck"></i></div>
                        <h5>ENV√çO R√ÅPIDO</h5>
                    </div>
                    <div class="col-3 icon-feature">
                        <div class="icon-circle shadow-sm"><i class="bi bi-wallet2"></i></div>
                        <h5>PAGO SEGURO</h5>
                    </div>
                    <div class="col-3 icon-feature">
                        <div class="icon-circle shadow-sm"><i class="bi bi-patch-check"></i></div>
                        <h5>CALIDAD</h5>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- CATEGOR√çAS G√âNERO (VISIBLE SIEMPRE) -->
    <div class="container category-filter-bar">
        <button class="filter-pill active" data-filter="all">Ver Todo</button>
        <button class="filter-pill" data-filter="mujer">Mujer</button>
        <button class="filter-pill" data-filter="hombre">Hombre</button>
        <button class="filter-pill" data-filter="unisex">Unisex</button>
        <button class="filter-pill" data-filter="segunda">Segunda Oportunidad</button>
    </div>

    <div class="container mb-5">
        <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-2 g-md-4" id="productsContainer">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-success" role="status"></div>
                <p class="mt-2 text-muted">Cargando productos...</p>
            </div>
        </div>
    </div>

    <!-- Menu Flotante (Popup) -->
    <div id="floatingMenu" class="d-none position-fixed bg-white rounded shadow p-3"
        style="top: 70px; right: 10px; width: 200px; max-height: 60vh; overflow-y: auto; z-index: 2000; border: 1px solid #eee;">
        <h6 class="text-dark fw-bold mb-3 border-bottom pb-2">MARCAS</h6>
        <div class="d-flex flex-column gap-2" id="brandMenuContainer">
            <!-- Se llena din√°micamente -->
        </div>
    </div>

    <!-- Carrito -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas">
        <div class="offcanvas-header border-bottom">
            <h5 class="offcanvas-title fw-bold" style="color: var(--fitsyle-green);">Tu Carrito</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body d-flex flex-column">
            <div id="lista-carrito-container" class="flex-grow-1 overflow-auto"></div>

            <div id="cart-footer" class="cart-total-section d-none">
                <div class="cart-total-row">
                    <span class="cart-total-label">Total:</span>
                    <span class="cart-total-amount">$<span id="total">0.00</span></span>
                </div>

                <!-- PAYPAL BUTTON CONTAINER -->
                <div id="paypal-button-container" class="w-100 mb-2"></div>

                <button id="limpiar-carrito" class="btn btn-action-cart">
                    <i class="bi bi-trash3"></i> Vaciar Carrito
                </button>
            </div>
        </div>
    </div>

    <footer class="footer-main text-center">
        <div class="container">
            <h4 class="mb-3 font-oswald">FITSYLE</h4>
            <p class="small opacity-75">Estilo, confort y rendimiento.</p>
            <div class="mt-4 small">¬© 2025 FitSyle - Todos los derechos reservados.</div>
        </div>
    </footer>

    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1030;">
        <button id="aiChatToggleBtn" class="btn btn-ai-assistant rounded-circle shadow-lg" type="button"
            data-bs-toggle="modal" data-bs-target="#aiChatModal">
            <i class="bi bi-robot fs-3"></i>
        </button>
    </div>

    <div class="modal fade" id="aiChatModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 2rem; border: none; overflow: hidden;">
                <div class="modal-header" style="background-color: var(--fitsyle-green); color: white; border: none;">
                    <h5 class="modal-title"><i class="bi bi-robot me-2"></i>Asistente FitSyle</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="background-color: #f8f9fa;">
                    <div id="chat-messages" class="mb-3" style="height: 300px; overflow-y: auto; padding: 10px;"></div>
                    <div class="input-group">
                        <input type="text" id="chat-input" class="form-control" placeholder="Escribe tu pregunta..."
                            style="border-radius: 2rem 0 0 2rem;">
                        <button class="btn btn-primary" type="button" id="chat-send"
                            style="background-color: var(--fitsyle-green); border:none; border-radius: 0 2rem 2rem 0;"><i
                                class="bi bi-send"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- === INICIO MODAL LOGIN (Ya integrado) === -->
    <div class="modal fade modal-login-custom" id="loginModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalAuthTitle">Inicia Sesi√≥n</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <button id="googleLoginBtn" class="btn btn-google">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G"
                            width="20">
                        Continuar con Google
                    </button>
                    <div class="text-center text-muted mb-3 small">o ingresa con tu correo</div>
                    <form id="authForm">
                        <div class="mb-3 d-none" id="nameGroup">
                            <input type="text" class="form-control form-control-login" id="registerName"
                                placeholder="Tu Nombre">
                        </div>
                        <input type="email" class="form-control form-control-login" id="loginEmail"
                            placeholder="Correo electr√≥nico" required>
                        <input type="password" class="form-control form-control-login" id="loginPassword"
                            placeholder="Contrase√±a" required>
                        <button type="submit" class="btn btn-login-submit" id="submitBtn">INICIAR SESI√ìN</button>
                    </form>
                    <div class="text-center mt-3">
                        <a href="#" class="small text-success fw-bold text-decoration-none" id="toggleAuthMode">¬øNo
                            tienes cuenta? Reg√≠strate</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- === FIN MODAL LOGIN === -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CONFIGURACI√ìN DE AUTENTICACI√ìN (Tus nuevas llaves 'fitsyle')
        const authConfig = {
            apiKey: "AIzaSyAuyh4pHllhtZLbgFgfZF4tlJrncFy4R7g",
            authDomain: "fitsyle.firebaseapp.com",
            projectId: "fitsyle",
            storageBucket: "fitsyle.firebasestorage.app",
            messagingSenderId: "595367121052",
            appId: "1:595367121052:web:c19aac0ed1986dfb389d59",
            measurementId: "G-J46KZD01W3"
        };

        // CONFIGURACI√ìN DE BASE DE DATOS (Tus llaves antiguas 'proyecto1' donde est√°n los productos)
        const dbConfig = {
            apiKey: "AIzaSyB_LcA4zZk6gZcAPH38HDMxXVqlelgGLQ8",
            authDomain: "proyecto1-b6570.firebaseapp.com",
            projectId: "proyecto1-b6570",
            storageBucket: "proyecto1-b6570.firebasestorage.app",
            messagingSenderId: "575435247117",
            appId: "1:575435247117:web:88bfac2a385f43158a4f44",
            measurementId: "G-R4L645TLDL"
        };

        // Inicializaci√≥n H√≠brida
        const appAuth = initializeApp(authConfig, "AppLogin");
        const appDB = initializeApp(dbConfig, "AppProductos");

        const auth = getAuth(appAuth);
        const db = getFirestore(appDB);
        const googleProvider = new GoogleAuthProvider();

        // Habilitar persistencia offline si es posible
        enableIndexedDbPersistence(db).catch((err) => console.log('Persistencia:', err.code));

        // UI Elements
        const loginBtn = document.getElementById('loginBtn');
        const userDropdown = document.getElementById('userDropdown');
        const navUserName = document.getElementById('navUserName');
        const logoutBtn = document.getElementById('logoutBtn');
        const alertContainer = document.getElementById('alert-container');
        const toastContainer = document.getElementById('toast-container'); // Nuevo contenedor para toast
        const menuToggleBtn = document.getElementById('menuToggleBtn');
        const floatingMenu = document.getElementById('floatingMenu');
        
        // Elementos del Modal Auth
        const authForm = document.getElementById('authForm');
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const toggleAuthModeBtn = document.getElementById('toggleAuthMode');
        const nameGroup = document.getElementById('nameGroup');
        const submitBtn = document.getElementById('submitBtn');
        const modalTitle = document.getElementById('modalAuthTitle');
        let isRegisterMode = false;

        // --- FUNCIONES DE ALERTA ---
        window.showAlert = (message, type = 'success') => {
            const div = document.createElement('div');
            div.className = `alert alert-${type} alert-dismissible fade show shadow`;
            div.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(div);
            setTimeout(() => div.remove(), 6000);
        };

        // --- NUEVA FUNCI√ìN TOAST (Stock insuficiente, abajo, moderno, SIN AMONTONARSE) ---
        let toastTimeout; // Variable para controlar el tiempo del toast activo

        window.showToast = (message) => {
            const container = document.getElementById('toast-container');
            
            // 1. Limpiar cualquier toast existente inmediatamente
            container.innerHTML = ''; 
            if (toastTimeout) clearTimeout(toastTimeout);

            // 2. Crear nuevo toast
            const div = document.createElement('div');
            div.className = 'custom-toast show'; // Se muestra directamente
            div.innerHTML = `<i class="bi bi-exclamation-circle-fill"></i> <span>${message}</span>`;
            
            container.appendChild(div);

            // 3. Programar eliminaci√≥n
            toastTimeout = setTimeout(() => {
                div.classList.remove('show');
                div.classList.add('hide');
                setTimeout(() => {
                    // Verificaci√≥n extra para no borrar uno nuevo que haya entrado
                    if (container.contains(div)) div.remove();
                }, 300);
            }, 2500); // Duraci√≥n un poco m√°s corta para que se sienta √°gil
        };

        // --- AUTH: TOGGLE LOGIN / REGISTER ---
        if (toggleAuthModeBtn) {
            toggleAuthModeBtn.addEventListener('click', (e) => {
                e.preventDefault();
                isRegisterMode = !isRegisterMode;
                if (isRegisterMode) {
                    nameGroup.classList.remove('d-none');
                    modalTitle.textContent = "Crear Cuenta";
                    submitBtn.textContent = "REGISTRARSE";
                    toggleAuthModeBtn.textContent = "¬øYa tienes cuenta? Inicia Sesi√≥n";
                } else {
                    nameGroup.classList.add('d-none');
                    modalTitle.textContent = "Inicia Sesi√≥n";
                    submitBtn.textContent = "INICIAR SESI√ìN";
                    toggleAuthModeBtn.textContent = "¬øNo tienes cuenta? Reg√≠strate";
                }
            });
        }

        // --- AUTH: GOOGLE LOGIN (FIXED ERROR HANDLING) ---
        if (googleLoginBtn) {
            googleLoginBtn.addEventListener('click', async () => {
                // Prevent multiple clicks
                if (googleLoginBtn.disabled) return;
                googleLoginBtn.disabled = true;
                googleLoginBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Conectando...';

                try {
                    await signInWithPopup(auth, googleProvider);
                    const modalEl = document.getElementById('loginModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if(modal) modal.hide();
                    window.showAlert("¬°Bienvenido con Google!", "success");
                } catch (error) {
                    console.error("Google Auth Error:", error);
                    let msg = "Error al iniciar sesi√≥n con Google.";
                    if (error.code === 'auth/unauthorized-domain') {
                        msg = "‚ö†Ô∏è <b>Error de Dominio:</b> Este sitio no est√° autorizado. Agrega este dominio a 'Authorized Domains' en tu consola de Firebase.";
                    } else if (error.code === 'auth/popup-closed-by-user') {
                        msg = "Cancelaste el inicio de sesi√≥n.";
                    }
                    window.showAlert(msg, "danger");
                } finally {
                    googleLoginBtn.disabled = false;
                    googleLoginBtn.innerHTML = '<img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G" width="20"> Continuar con Google';
                }
            });
        }

        // --- AUTH: EMAIL / PASSWORD ---
        if (authForm) {
            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const name = document.getElementById('registerName').value;

                try {
                    if (isRegisterMode) {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        if (name) {
                            await updateProfile(userCredential.user, { displayName: name });
                        }
                        window.showAlert("Cuenta creada exitosamente", "success");
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                        window.showAlert("Bienvenido de nuevo", "success");
                    }
                    
                    const modalEl = document.getElementById('loginModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if(modal) modal.hide();
                    authForm.reset();

                } catch (error) {
                    console.error(error);
                    let msg = "Error de autenticaci√≥n";
                    if(error.code === 'auth/wrong-password') msg = "Contrase√±a incorrecta";
                    if(error.code === 'auth/user-not-found') msg = "Usuario no encontrado";
                    if(error.code === 'auth/email-already-in-use') msg = "El correo ya est√° registrado";
                    if(error.code === 'auth/weak-password') msg = "La contrase√±a debe tener al menos 6 caracteres";
                    window.showAlert(msg, "danger");
                }
            });
        }

        // Toggle Menu Flotante
        if (menuToggleBtn) {
            menuToggleBtn.onclick = (e) => {
                e.stopPropagation();
                floatingMenu.classList.toggle('d-none');
            };
        }

        // Cerrar men√∫ al hacer click fuera
        document.addEventListener('click', (e) => {
            if (floatingMenu && !floatingMenu.contains(e.target) && menuToggleBtn && !menuToggleBtn.contains(e.target)) {
                floatingMenu.classList.add('d-none');
            }
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginBtn.classList.add('d-none');
                userDropdown.classList.remove('d-none');
                const name = user.displayName || 'Usuario';
                navUserName.textContent = name;
            } else {
                loginBtn.classList.remove('d-none');
                userDropdown.classList.add('d-none');
                navUserName.textContent = "";
            }
        });

        logoutBtn.onclick = (e) => {
            e.preventDefault();
            signOut(auth).then(() => {
                window.showAlert("Sesi√≥n cerrada", "success");
                setTimeout(() => window.location.reload(), 1000);
            });
        };

        window.addEventListener('offline', () => document.getElementById('offline-indicator').classList.remove('d-none'));
        window.addEventListener('online', () => document.getElementById('offline-indicator').classList.add('d-none'));

        let allProducts = [];
        let carrito = JSON.parse(localStorage.getItem("carrito")) || [];
        renderCart();

        let currentCategory = 'all';
        let currentBrand = 'all';
        let currentSearchTerm = '';

        const productsContainer = document.getElementById('productsContainer');
        const searchInput = document.getElementById('searchInput');
        const clearSearchBtn = document.getElementById('clearSearchBtn');

        const cachedProducts = localStorage.getItem('productosCache');
        if (cachedProducts) {
            allProducts = JSON.parse(cachedProducts);
            renderProducts(allProducts);
            updateBrandMenu();
        }

        const q = query(collection(db, "productos"), orderBy("createdAt", "desc"));

        onSnapshot(q, (snapshot) => {
            const nuevosProductos = snapshot.docs.map(doc => {
                const d = doc.data();
                return {
                    id: doc.id,
                    nombre: d.nombre || '',
                    precio: Number(d.precio) || 0,
                    descripcion: d.descripcion || '',
                    imagenes: d.imagenes || [],
                    imagenUrl: d.imagenUrl || 'https://via.placeholder.com/300x300?text=No+Image',
                    genero: d.genero || 'UNISEX',
                    marca: d.marca,
                    tallaRopa: d.tallaRopa,
                    tallaCalzado: d.tallaCalzado,
                    stock: Number(d.stock),
                    esSegundaOportunidad: d.esSegundaOportunidad === true
                };
            });
            if (nuevosProductos.length > 0) {
                allProducts = nuevosProductos;
                localStorage.setItem('productosCache', JSON.stringify(allProducts));
                updateBrandMenu();
                applyFilters();
            }
        });

        function updateBrandMenu() {
            const brands = [...new Set(allProducts.map(p => p.marca).filter(Boolean))].sort();
            const container = document.getElementById('brandMenuContainer');
            if (!container) return;

            // Mantener el bot√≥n "Ver Todas"
            container.innerHTML = '<button class="filter-pill-menu w-100 text-start border-0 mb-1 active" data-brand="all">Ver Todas</button>';

            brands.forEach(brand => {
                const btn = document.createElement('button');
                btn.className = 'filter-pill-menu w-100 text-start border-0 mb-1';
                btn.dataset.brand = brand;
                btn.textContent = brand;
                btn.onclick = () => {
                    // Highlight active
                    document.querySelectorAll('#brandMenuContainer .filter-pill-menu').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    currentBrand = brand;
                    applyFilters();
                    if (floatingMenu) floatingMenu.classList.add('d-none');
                };
                container.appendChild(btn);
            });

            // Re-attach event listener for "Ver Todas"
            const allBtn = container.querySelector('[data-brand="all"]');
            allBtn.onclick = () => {
                document.querySelectorAll('#brandMenuContainer .filter-pill-menu').forEach(b => b.classList.remove('active'));
                allBtn.classList.add('active');

                currentBrand = 'all';
                applyFilters();
                if (floatingMenu) floatingMenu.classList.add('d-none');
            };
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function applyFilters() {
            let filtered = [...allProducts];

            // Filtro Categor√≠a (G√©nero)
            if (currentCategory === 'mujer') filtered = filtered.filter(p => p.genero === 'MUJER');
            else if (currentCategory === 'hombre') filtered = filtered.filter(p => p.genero === 'HOMBRE');
            else if (currentCategory === 'unisex') filtered = filtered.filter(p => p.genero === 'UNISEX');
            else if (currentCategory === 'segunda') filtered = filtered.filter(p => p.esSegundaOportunidad === true);

            // Filtro Marca
            if (currentBrand !== 'all') {
                filtered = filtered.filter(p => p.marca === currentBrand);
            }

            if (currentSearchTerm) {
                const term = currentSearchTerm.toLowerCase();
                filtered = filtered.filter(p =>
                    p.nombre.toLowerCase().includes(term) ||
                    p.descripcion.toLowerCase().includes(term) ||
                    (p.marca && p.marca.toLowerCase().includes(term))
                );
            }

            // Randomize if "Ver Todo" is selected (no specific category/brand/search)
            if (currentCategory === 'all' && currentBrand === 'all' && !currentSearchTerm) {
                shuffleArray(filtered);
            }

            renderProducts(filtered);
        }

        // Manejo de filtros de Categor√≠a (Barra Horizontal)
        document.querySelectorAll('.filter-pill').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-pill').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentCategory = btn.dataset.filter;
                applyFilters();
            });
        });

        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                currentSearchTerm = e.target.value.trim();
                clearSearchBtn.classList.toggle('d-none', currentSearchTerm.length === 0);
                applyFilters();
            });
        }

        if (clearSearchBtn) {
            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                currentSearchTerm = '';
                clearSearchBtn.classList.add('d-none');
                applyFilters();
                searchInput.focus();
            });
        }

        window.toggleDescription = (card) => {
            const text = card.querySelector('.card-text');
            if (text) text.classList.toggle('expanded');
        };

        function renderProducts(products) {
            productsContainer.innerHTML = '';
            if (products.length === 0) {
                productsContainer.innerHTML = '<div class="col-12 text-center py-5"><p class="text-muted fs-5">Cargando productos...</p></div>';
                return;
            }

            products.forEach(p => {
                let imgHTML = `<img src="${p.imagenUrl}" class="product-img" alt="${p.nombre}">`;
                if (p.imagenes.length > 1) {
                    const slides = p.imagenes.map((url, i) =>
                        `<div class="carousel-item ${i === 0 ? 'active' : ''}"><img src="${url}" class="product-img" alt="${p.nombre}"></div>`
                    ).join('');
                    imgHTML = `<div id="car-${p.id}" class="carousel slide h-100" data-bs-ride="false"><div class="carousel-inner h-100">${slides}</div></div>`;
                }

                let talla = p.tallaRopa ? p.tallaRopa : (p.tallaCalzado ? p.tallaCalzado + ' MX' : '');
                let tallaBadge = talla ? `<span class="badge-talla-client">${talla}</span>` : '';
                let segundaBadge = p.esSegundaOportunidad ? `<div class="badge-segunda-container"><span class="badge-segunda-oportunidad">2da Oportunidad</span></div>` : '';
                const btnState = p.stock <= 0 ? 'disabled' : '';
                const btnText = p.stock <= 0 ? 'Agotado' : 'A√±adir al Carrito';

                const html = `
                <div class="col product-item">
                    <div class="card-product-style" onclick="toggleDescription(this)">
                        <div class="img-wrapper">${imgHTML}</div>
                        <div class="card-body">
                            <h5 class="card-title">${p.nombre}</h5>
                            <div class="badges-container">
                                <span class="badge-marca-client">${p.marca || 'GENERICO'}</span>
                                <span class="badge-genero-client">${p.genero || 'UNISEX'}</span>
                                ${tallaBadge}
                                ${segundaBadge} 
                            </div>
                            <p class="card-text">${p.descripcion}</p>
                            <div class="price-stock-container">
                                <p class="price">$${p.precio.toFixed(2)}</p>
                                <small class="stock-info">${p.stock} disponibles</small>
                            </div>
                            <div class="actions-container">
                                <input type="number" id="qty-${p.id}" class="qty-input" value="1" min="1" max="${p.stock}" onclick="event.stopPropagation()">
                                <button class="btn-add-cart" onclick="event.stopPropagation(); window.addToCart('${p.id}')" ${btnState}>${btnText}</button>
                            </div>
                        </div>
                    </div>
                </div>`;
                productsContainer.innerHTML += html;
            });

            document.querySelectorAll('.card-product-style .carousel').forEach(el => {
                const bsCar = new bootstrap.Carousel(el, { interval: 1500, pause: false });
                el.closest('.card-product-style').addEventListener('mouseenter', () => bsCar.cycle());
                el.closest('.card-product-style').addEventListener('mouseleave', () => { bsCar.pause(); bsCar.to(0); });
            });
        }

        window.addToCart = (id) => {
            const prod = allProducts.find(p => p.id === id);
            const qtyInput = document.getElementById(`qty-${id}`);
            const qty = parseInt(qtyInput.value) || 1;
            if (qty > prod.stock) { 
                // AQUI CAMBIE LA ALERTA A LA NUEVA TOAST (Abajo)
                window.showToast(`Stock insuficiente. Solo quedan ${prod.stock}`); 
                return; 
            }
            const exist = carrito.find(i => i.id === id);
            if (exist) {
                if (exist.cantidad + qty > prod.stock) { 
                    window.showToast("Stock insuficiente"); 
                    return; 
                }
                exist.cantidad += qty;
            } else {
                carrito.push({ ...prod, cantidad: qty });
            }
            saveCart();
            qtyInput.value = 1;
            // AQUI QUITE LA ALERTA DE PRODUCTO AGREGADO (No hace nada visualmente, solo agrega)
        };

        window.removeFromCart = (idx) => {
            if (confirm("¬øEliminar producto?")) {
                carrito.splice(idx, 1);
                saveCart();
            }
        };

        function saveCart() {
            localStorage.setItem("carrito", JSON.stringify(carrito));
            renderCart();
        }

        function renderCart() {
            const container = document.getElementById('lista-carrito-container');
            const footer = document.getElementById('cart-footer');
            container.innerHTML = '';

            if (carrito.length === 0) {
                // DISE√ëO ORIGINAL CARRITO VAC√çO
                container.innerHTML = `
                    <div class="empty-cart-message">
                        <i class="bi bi-bag-x empty-cart-icon"></i>
                        <h5 class="empty-cart-title">Tu carrito est√° vac√≠o</h5>
                        <p class="empty-cart-text">¬°Explora nuestra tienda y encuentra tu estilo!</p>
                        <button class="btn btn-action-cart w-75 mx-auto" data-bs-dismiss="offcanvas">Ir a Comprar</button>
                    </div>`;
                footer.classList.add('d-none');
                document.getElementById('cart-badge').classList.add('d-none');
                return;
            } else {
                footer.classList.remove('d-none');
            }

            let total = 0;
            let count = 0;

            carrito.forEach((item, idx) => {
                total += item.precio * item.cantidad;
                count += item.cantidad;
                container.innerHTML += `
                    <div class="cart-item-card">
                        <img src="${item.imagenUrl}" class="cart-item-img" alt="${item.nombre}" onerror="this.src='https://via.placeholder.com/100x100?text=Error'">
                        <div class="cart-item-info">
                            <div class="cart-item-title">${item.nombre}</div>
                            <div>
                                <span class="cart-item-price-pill">${item.cantidad} x $${item.precio.toFixed(0)}</span>
                                <span class="cart-item-total">$${(item.precio * item.cantidad).toFixed(2)}</span>
                            </div>
                        </div>
                        <button class="btn-remove-item" onclick="window.removeFromCart(${idx})"><i class="bi bi-x-lg"></i></button>
                    </div>`;
            });

            document.getElementById('total').innerText = total.toFixed(2);
            const badge = document.getElementById('cart-badge');
            badge.innerText = count;
            badge.classList.remove('d-none');
        }

        document.getElementById('limpiar-carrito').onclick = () => { if (confirm("¬øVaciar carrito?")) { carrito = []; saveCart(); } };

        // --- PAYPAL DYNAMIC INITIALIZATION (DEFENSIVE LOADING) ---
        const loadPayPal = () => {
            const script = document.createElement('script');
            // Usando tu Client ID original
            script.src = "https://www.paypal.com/sdk/js?client-id=ARhOIBjuNzQQeGRv84_3n7kiuTWPY90fGLRUGAHlcTAmEJsoXnTiHgIgaM1-ZFIRhpni_SMlTIG0hyuo&currency=MXN";
            script.async = true;
            script.onload = () => {
                // Delay init slightly to ensure DOM is ready
                setTimeout(initPayPalButtons, 500);
            };
            script.onerror = () => {
                console.warn("PayPal SDK fail to load");
                fallbackPayPalUI();
            };
            document.head.appendChild(script);
        };

        function fallbackPayPalUI() {
            const container = document.getElementById('paypal-button-container');
            if (container) {
                container.innerHTML = '<div class="alert alert-light small text-center text-muted">Pago online no disponible en vista previa.</div>';
            }
        }

        function initPayPalButtons() {
            if (typeof paypal === 'undefined') {
                fallbackPayPalUI();
                return;
            }
            
            try {
                // Check if container exists
                if (!document.getElementById('paypal-button-container')) return;

                const buttons = paypal.Buttons({
                    style: {
                        layout: 'vertical',
                        color: 'gold',
                        shape: 'pill',
                        label: 'pay',
                        height: 40
                    },
                    createOrder: function (data, actions) {
                        const totalAmount = document.getElementById('total').innerText;
                        return actions.order.create({
                            purchase_units: [{
                                amount: { value: totalAmount }
                            }]
                        });
                    },
                    onApprove: function (data, actions) {
                        return actions.order.capture().then(function (details) {
                            window.showAlert('Pago completado por ' + details.payer.name.given_name, 'success');
                            carrito = [];
                            saveCart();
                            bootstrap.Offcanvas.getInstance(document.getElementById('cartOffcanvas')).hide();
                        });
                    },
                    onError: function (err) {
                        console.error("PayPal Button Error:", err);
                        // Suppress alert for window host error which is common in sandboxes
                        if (!JSON.stringify(err).includes('window host')) {
                            window.showAlert("Error en el pago", "danger");
                        }
                    }
                });

                // Wrap render in try-catch to suppress sandbox errors
                try {
                    buttons.render('#paypal-button-container').catch(err => {
                        console.warn("PayPal render warning:", err);
                        fallbackPayPalUI();
                    });
                } catch (renderErr) {
                    console.warn("PayPal render error:", renderErr);
                    fallbackPayPalUI();
                }

            } catch (e) {
                console.error("PayPal Initialization Error:", e);
                fallbackPayPalUI();
            }
        }

        // Iniciar carga de PayPal
        loadPayPal();

        // --- BOT DE IA ---
        document.addEventListener('DOMContentLoaded', function () {
            const sendBtn = document.getElementById('chat-send');
            const chatInput = document.getElementById('chat-input');
            const chatMsgs = document.getElementById('chat-messages');
            let chatWelcomeShown = false;

            if (!chatWelcomeShown) {
                appendMessage("¬°Hola! üëã Soy tu asistente personal de FitSyle. ¬øBuscas algo en especial hoy? üëü‚ú®", 'ai');
                chatWelcomeShown = true;
            }

            function getProductListFromDOM() {
                const products = [];
                document.querySelectorAll('.card-product-style').forEach(card => {
                    const title = card.querySelector('.card-title')?.textContent.trim() || 'Producto';
                    const price = card.querySelector('.price')?.textContent.trim() || 'N/A';
                    products.push({ nombre: title, precio: price });
                });
                return products;
            }

            async function callGeminiAPI(userQuery) {
                const productsFromPage = getProductListFromDOM();
                const systemPrompt = `Eres un asistente de ventas de FitSyle. Responde corto y con emojis. Productos visibles: ${JSON.stringify(productsFromPage)}`;
                const apiKey = "AIzaSyBK5X1dROuIiq0NPhtXL7Yc6A7IVhMdO84";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    let aiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text || "No te entend√≠ bien.";
                    aiResponse = aiResponse.replace(/[*_~`]/g, '');
                    appendMessage(aiResponse, 'ai');
                } catch (error) {
                    appendMessage("Error de conexi√≥n con la IA.", 'error');
                }
            }

            function appendMessage(text, type) {
                const div = document.createElement('div');
                div.className = type === 'user' ? "text-end mb-2" : "text-start mb-2";
                let colorClass = type === 'error' ? 'ai text-danger' : type;
                div.innerHTML = `<span class="ai-chat-message ${colorClass} d-inline-block text-start">${text.replace(/\n/g, '<br>')}</span>`;
                chatMsgs.appendChild(div);
                chatMsgs.scrollTop = chatMsgs.scrollHeight;
            }

            function sendMessage() {
                const text = chatInput.value.trim();
                if (text) { appendMessage(text, 'user'); chatInput.value = ''; callGeminiAPI(text); }
            }

            sendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', function (e) { if (e.key === 'Enter') sendMessage(); });
        });
    </script>
</body>

</html>