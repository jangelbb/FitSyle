<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" />
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#014421">
  <title>Admin - FitSyle</title>

  <!-- Fuentes y Estilos -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <style>
    :root {
      --brand-green: #014421;
      --bg-color: #f9f9f9;
      --text-main: #111111;
      --btn-gray-dark: #cfcfcf; 
    }

    body {
      background-color: var(--bg-color);
      font-family: 'Poppins', sans-serif !important;
      color: var(--text-main);
      padding-top: 60px; /* Header delgado */
    }

    /* === NAVBAR === */
    .navbar-custom {
      background-color: var(--brand-green) !important;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
      padding: 0.4rem 0;
    }

    .navbar-brand {
      color: white !important;
      font-weight: 800;
      font-family: 'Poppins', sans-serif !important;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-right: 5px; /* Reducido para móvil */
    }

    .navbar-logo {
      height: 30px;
      width: 30px;
      border-radius: 50%;
      object-fit: cover;
    }

    /* === BARRA DE BÚSQUEDA === */
    .search-container {
      flex-grow: 1;
      max-width: 500px;
      margin: 0 10px;
      position: relative;
    }
    
    .search-input-wrapper {
      position: relative;
      width: 100%;
    }

    .search-input {
      width: 100%;
      border-radius: 20px;
      border: none;
      padding: 6px 30px 6px 30px; /* Padding ajustado */
      font-size: 0.9rem;
      outline: none;
      background-color: white;
      color: #333;
      height: 36px;
    }

    .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #888;
      pointer-events: none;
      font-size: 0.9rem;
    }

    .search-clear-icon {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #888;
      cursor: pointer;
      font-size: 0.9rem;
    }

    /* === BOTONES HEADER === */
    .header-actions {
      display: flex;
      align-items: center;
      gap: 2px; /* Gap muy pequeño en móvil */
    }

    .btn-icon-header {
      color: white;
      font-size: 1.2rem;
      background: transparent;
      border: none;
      padding: 4px 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s;
    }
    .btn-icon-header:hover { opacity: 0.8; }

    /* Botón "Nuevo" en móvil (Círculo pequeño) */
    .btn-new-mobile {
      background-color: rgba(255,255,255,0.2);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      border: none;
      text-decoration: none;
      margin-right: 2px;
    }
    .btn-new-mobile i { font-size: 1rem; }

    /* === MEDIA QUERIES (OPTIMIZACIÓN MÓVIL) === */
    @media (max-width: 576px) {
        .container-fluid { padding-left: 10px; padding-right: 10px; }
        
        /* 1. Logo y Texto más pequeños */
        .navbar-brand { font-size: 1rem; gap: 4px; }
        .navbar-logo { height: 26px; width: 26px; }

        /* 2. Barra de búsqueda reducida */
        .search-container {
            margin: 0 5px;
            max-width: 130px; /* Ancho forzado pequeño */
        }
        .search-input {
            padding: 5px 25px 5px 25px; /* Menos padding */
            font-size: 0.8rem;
            height: 32px;
        }
        .search-icon, .search-clear-icon { font-size: 0.8rem; }
        .search-icon { left: 8px; }

        /* 3. Iconos más compactos */
        .header-actions { gap: 0; }
        .btn-icon-header { padding: 4px 5px; font-size: 1.1rem; }
        .btn-new-mobile { width: 30px; height: 30px; }
    }

    /* === MENÚ FLOTANTE === */
    #floatingMenu {
      top: 60px; 
      right: 10px; 
      width: 220px; 
      max-height: 80vh; 
      overflow-y: auto; 
      z-index: 2000;
      border-radius: 15px;
      border: 1px solid #eee;
    }

    .menu-section-title {
      font-size: 0.75rem;
      font-weight: 700;
      color: #888;
      margin-bottom: 6px;
      text-transform: uppercase;
      padding-left: 5px;
    }

    .filter-pill-menu {
      width: 100%;
      text-align: left;
      background: white;
      border: 1px solid #f0f0f0;
      padding: 8px 12px;
      border-radius: 8px;
      margin-bottom: 5px;
      font-size: 0.85rem;
      color: #333;
      transition: all 0.2s;
    }
    .filter-pill-menu:hover, .filter-pill-menu.active {
      background-color: var(--brand-green);
      color: white;
      border-color: var(--brand-green);
    }

    /* === TARJETAS === */
    .product-card {
      background: white;
      border: 1px solid #f0f0f0;
      border-radius: 8px;
      overflow: hidden;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .img-container {
      position: relative;
      width: 100%;
      padding-top: 100%;
      background-color: #f8f8f8;
      overflow: hidden;
    }
    .product-img {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; mix-blend-mode: multiply;
    }

    .card-body-custom {
      padding: 10px;
      display: flex; flex-direction: column; flex-grow: 1; text-align: left; cursor: pointer;
    }

    .product-title {
      font-weight: 700; font-size: 0.9rem; color: #000; line-height: 1.2; margin-bottom: 6px;
    }

    .badge-group { display: flex; gap: 3px; margin-bottom: 6px; flex-wrap: wrap; }
    .badge-brand, .badge-gender, .badge-size {
      font-size: 0.55rem; font-weight: 700; padding: 2px 5px; border-radius: 3px;
    }
    .badge-brand { background-color: #000; color: #fff; text-transform: uppercase; }
    .badge-gender { background-color: #e0e0e0; color: #000; text-transform: uppercase; }
    .badge-size { border: 1px solid var(--brand-green); color: var(--brand-green); background: white; }

    .badge-second {
      background-color: #1a4d2e; color: white; font-size: 0.5rem; font-weight: 700;
      padding: 2px 4px; border-radius: 3px; text-transform: uppercase; margin-bottom: 6px;
      display: inline-block; width: fit-content;
    }

    .product-desc {
      font-size: 0.8rem; color: #666; line-height: 1.3; margin-bottom: 6px;
      display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
    }
    .product-desc.expanded { -webkit-line-clamp: unset !important; overflow: visible; color: #333; }

    .product-price {
      font-size: 1rem; font-weight: 800; color: var(--brand-green); margin-bottom: 2px;
    }

    .product-stock { font-size: 0.7rem; color: #888; margin-bottom: 10px; }

    .btn-delete-full {
      width: 100%; background-color: var(--btn-gray-dark); color: #333; border: none;
      padding: 8px; border-radius: 25px; font-weight: 700; font-size: 0.8rem;
      margin-top: auto; display: flex; align-items: center; justify-content: center; gap: 5px;
    }
    .btn-delete-full:hover { background-color: #b0b0b0; }

    /* === FORMULARIO MODAL === */
    .modal-content { border-radius: 20px; border: none; }
    .modal-header { background-color: var(--brand-green); color: white; border-radius: 20px 20px 0 0; }
    .btn-close { filter: invert(1); }

    .btn-segunda-opt {
        display: flex; width: 100%; background-color: var(--brand-green); color: white;
        align-items: center; justify-content: center; gap: 10px;
        padding: 10px; border-radius: 50px; font-weight: 700; font-size: 1rem;
        cursor: pointer; transition: all 0.3s; border: 2px solid var(--brand-green);
    }
    .btn-check-custom:not(:checked) + .btn-segunda-opt { background-color: white; color: var(--brand-green); opacity: 0.8; }
    .btn-check-custom:checked + .btn-segunda-opt { box-shadow: 0 4px 15px rgba(1, 68, 33, 0.3); }

    .btn-save-custom { background-color: var(--brand-green); color: white; border: none; font-weight: 600; }
    .btn-save-custom:hover { background-color: #025e2e; color: white; }
    .required-asterisk { color: #dc3545; margin-left: 2px; }

    .thumb-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 5px; }
    .thumb { width: 100%; height: 60px; object-fit: cover; border-radius: 4px; }
    
    #loadingOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.8); z-index: 9999;
        display: flex; justify-content: center; align-items: center; flex-direction: column;
    }
  </style>
</head>

<body>

  <div id="loadingOverlay">
      <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;"></div>
      <p class="mt-3 fw-bold text-muted">Cargando...</p>
  </div>

  <!-- Navbar -->
  <nav class="navbar navbar-custom fixed-top">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      
      <!-- LOGO + TEXTO (Adaptable) -->
      <a class="navbar-brand" href="index.html">
        <img src="logo.png" alt="Logo" class="navbar-logo" onerror="this.src='https://placehold.co/30x30'">
        <!-- En móvil dice "Admin", en PC dice "FitSyle Admin" -->
        <span class="d-none d-sm-inline">FitSyle Admin</span>
        <span class="d-sm-none">Admin</span>
      </a>

      <!-- BUSCADOR (Reducido en móvil) -->
      <div class="search-container">
          <div class="search-input-wrapper">
              <i class="bi bi-search search-icon"></i>
              <input type="text" id="searchInput" class="search-input" placeholder="Buscar...">
              <i class="bi bi-x search-clear-icon d-none" id="clearSearchBtn"></i>
          </div>
      </div>

      <!-- BOTONES DERECHA -->
      <div class="header-actions">
          <button class="btn-new-mobile" data-bs-toggle="modal" data-bs-target="#productoModal" title="Nuevo">
              <i class="bi bi-plus-lg"></i>
          </button>
          
          <a href="FitSyle.html" class="btn-icon-header" title="Tienda">
              <i class="bi bi-shop"></i>
          </a>

          <button class="btn-icon-header" type="button" id="menuToggleBtn">
              <i class="bi bi-list"></i>
          </button>
      </div>
    </div>
  </nav>

  <!-- MENU FLOTANTE -->
  <div id="floatingMenu" class="d-none position-fixed bg-white shadow p-3">
    <h6 class="menu-section-title">Categorías</h6>
    <div class="d-flex flex-column mb-3">
        <button class="filter-pill-menu active" data-filter="all">Ver Todo</button>
        <button class="filter-pill-menu" data-filter="mujer">Mujer</button>
        <button class="filter-pill-menu" data-filter="hombre">Hombre</button>
        <button class="filter-pill-menu" data-filter="unisex">Unisex</button>
        <button class="filter-pill-menu" data-filter="segunda">Segunda Oportunidad</button>
    </div>
    <h6 class="menu-section-title border-top pt-2">Marcas</h6>
    <div class="d-flex flex-column" id="brandMenuContainer"></div>
  </div>

  <main class="container py-4">
    <div id="productsContainer" class="row g-2"></div> <!-- Gutter reducido a g-2 -->
  </main>

  <!-- Modal Nuevo Producto -->
  <div class="modal fade" id="productoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content shadow-lg">
        <div class="modal-header">
          <h5 class="modal-title fw-bold"><i class="bi bi-tag-fill me-2"></i> Nuevo producto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="productoForm">
          <div class="modal-body p-4">
            <h6 class="text-uppercase fw-bold mb-3 small text-muted border-bottom pb-2">Información Básica</h6>
            <div class="row g-3 mb-4">
              <div class="col-12">
                <label class="form-label fw-semibold">Nombre <span class="required-asterisk">*</span></label>
                <input id="nombreProducto" class="form-control" placeholder="Ej. Accolade Crew Neck" required />
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">Precio <span class="required-asterisk">*</span></label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="number" step="0.01" id="precioProducto" class="form-control" placeholder="0.00" required />
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">Stock <span class="required-asterisk">*</span></label>
                <input type="number" id="stock" class="form-control" value="1" required />
              </div>
              <div class="col-12 mt-3">
                 <input type="checkbox" class="btn-check btn-check-custom" id="esSegundaOportunidad" autocomplete="off">
                 <label class="btn-segunda-opt" for="esSegundaOportunidad">
                    <i class="bi bi-recycle"></i> Segunda Oportunidad
                 </label>
              </div>
            </div>

            <h6 class="text-uppercase fw-bold mb-3 small text-muted border-bottom pb-2">Detalles</h6>
            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label class="form-label fw-semibold">Marca <span class="required-asterisk">*</span></label>
                <select id="marcaSelect" class="form-select" required>
                  <option value="" selected disabled>Seleccionar...</option>
                  <option value="NIKE">Nike</option>
                  <option value="ADIDAS">Adidas</option>
                  <option value="ALO">Alo Yoga</option>
                  <option value="NEW BALANCE">New Balance</option>
                  <option value="ON">On Running</option>
                  <option value="LULULEMON">Lululemon</option>
                  <option value="OTRO">Otro</option>
                </select>
                <input type="text" id="marcaManual" class="form-control mt-2 d-none" placeholder="Escribe la marca...">
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">Género <span class="required-asterisk">*</span></label>
                <select id="genero" class="form-select" required>
                  <option value="HOMBRE">Hombre</option>
                  <option value="MUJER">Mujer</option>
                  <option value="UNISEX">Unisex</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">Categoría <span class="required-asterisk">*</span></label>
                <select id="tipoProducto" class="form-select" required>
                  <option value="" selected disabled>Seleccionar...</option>
                  <option value="Calzado">Calzado</option>
                  <option value="Playeras">Playeras</option>
                  <option value="Tops">Tops</option>
                  <option value="Shorts">Shorts</option>
                  <option value="Sudaderas">Sudaderas</option>
                  <option value="Hoodies">Hoodies</option>
                  <option value="Faldas">Faldas</option>
                  <option value="Leggins">Leggins</option>
                  <option value="Accesorios">Accesorios</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">Talla</label>
                <div id="divTallaRopa" class="d-none">
                  <select id="tallaRopa" class="form-select">
                    <option value="" selected disabled>Elige talla...</option>
                    <option value="XS">XS</option><option value="S">S</option>
                    <option value="M">M</option><option value="L">L</option>
                    <option value="XL">XL</option>
                  </select>
                </div>
                <!-- AQUÍ SE QUITA "MX" DE LAS OPCIONES DE CALZADO -->
                <div id="divTallaCalzado" class="d-none">
                   <select id="tallaCalzado" class="form-select">
                    <option value="" selected disabled>Elige número...</option>
                    <option value="23">23</option><option value="24">24</option>
                    <option value="25">25</option><option value="26">26</option>
                    <option value="27">27</option><option value="28">28</option>
                    <option value="29">29</option>
                  </select>
                </div>
                <div id="mensajeSinTipo" class="text-muted small mt-2">Selecciona categoría primero.</div>
              </div>
            </div>
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label fw-semibold">Descripción <span class="required-asterisk">*</span></label>
                <textarea id="descripcion" class="form-control" rows="3" placeholder="Detalles del producto..."></textarea>
              </div>
              <div class="col-12">
                <label class="form-label fw-semibold">Fotos</label>
                <input type="file" id="imagenesProducto" class="form-control" accept="image/*" multiple />
                <div id="previewImagenes" class="thumb-grid mt-2"></div>
              </div>
            </div>
          </div>
          <div class="modal-footer bg-light">
            <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-save-custom rounded-pill px-4" type="submit" id="submitBtn">
              <span class="spinner-border spinner-border-sm d-none" id="submitSpinner"></span>
              Guardar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    const firebaseConfig = {
      apiKey: "", 
      authDomain: "proyecto1-b6570.firebaseapp.com",
      projectId: "proyecto1-b6570",
      storageBucket: "proyecto1-b6570.firebasestorage.app",
      messagingSenderId: "575435247117",
      appId: "1:575435247117:web:88bfac2a385f43158a4f44"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      onSnapshot, query, orderBy, deleteDoc, doc, enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    try { enableIndexedDbPersistence(db); } catch(e){}

    const cloudName = "dwvwltsgc";
    const uploadPreset = "pwa_unsigned";

    // Variables UI
    const container = document.getElementById('productsContainer');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const modalElement = document.getElementById('productoModal');
    const modal = new bootstrap.Modal(modalElement);
    const form = document.getElementById('productoForm');
    
    const searchInput = document.getElementById('searchInput');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const menuToggleBtn = document.getElementById('menuToggleBtn');
    const floatingMenu = document.getElementById('floatingMenu');
    const brandMenuContainer = document.getElementById('brandMenuContainer');
    
    // Filtros inputs Form
    const marcaSelect = document.getElementById('marcaSelect');
    const marcaManual = document.getElementById('marcaManual');
    const tipoProductoSelect = document.getElementById('tipoProducto');
    const divTallaRopa = document.getElementById('divTallaRopa');
    const divTallaCalzado = document.getElementById('divTallaCalzado');
    const mensajeSinTipo = document.getElementById('mensajeSinTipo');
    const previewDiv = document.getElementById('previewImagenes');
    const imagenesInput = document.getElementById('imagenesProducto');

    let allProducts = [];
    let currentCategory = 'all';
    let currentBrand = 'all';
    let currentSearchTerm = '';

    // LOGICA UI
    menuToggleBtn.onclick = (e) => { e.stopPropagation(); floatingMenu.classList.toggle('d-none'); };
    document.addEventListener('click', (e) => {
        if (!floatingMenu.contains(e.target) && !menuToggleBtn.contains(e.target)) floatingMenu.classList.add('d-none');
    });

    document.querySelectorAll('.filter-pill-menu').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.filter-pill-menu[data-filter]').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentCategory = btn.dataset.filter;
            applyFilters();
            floatingMenu.classList.add('d-none');
        });
    });

    searchInput.addEventListener('input', (e) => {
        currentSearchTerm = e.target.value.trim();
        clearSearchBtn.classList.toggle('d-none', currentSearchTerm.length === 0);
        applyFilters();
    });

    clearSearchBtn.addEventListener('click', () => {
        searchInput.value = ''; currentSearchTerm = '';
        clearSearchBtn.classList.add('d-none'); applyFilters();
    });

    function updateBrandMenu() {
        const brands = [...new Set(allProducts.map(p => p.marca).filter(Boolean))].sort();
        brandMenuContainer.innerHTML = '';
        
        const allBtn = document.createElement('button');
        allBtn.className = `filter-pill-menu ${currentBrand === 'all' ? 'active' : ''}`;
        allBtn.textContent = 'Ver Todas';
        allBtn.onclick = () => { currentBrand = 'all'; updateBrandMenu(); applyFilters(); floatingMenu.classList.add('d-none'); };
        brandMenuContainer.appendChild(allBtn);

        brands.forEach(brand => {
            const btn = document.createElement('button');
            btn.className = `filter-pill-menu ${currentBrand === brand ? 'active' : ''}`;
            btn.textContent = brand;
            btn.onclick = () => { currentBrand = brand; updateBrandMenu(); applyFilters(); floatingMenu.classList.add('d-none'); };
            brandMenuContainer.appendChild(btn);
        });
    }

    function applyFilters() {
        let filtered = [...allProducts];
        if (currentCategory === 'mujer') filtered = filtered.filter(p => p.genero === 'MUJER');
        else if (currentCategory === 'hombre') filtered = filtered.filter(p => p.genero === 'HOMBRE');
        else if (currentCategory === 'unisex') filtered = filtered.filter(p => p.genero === 'UNISEX');
        else if (currentCategory === 'segunda') filtered = filtered.filter(p => p.esSegundaOportunidad === true);

        if (currentBrand !== 'all') filtered = filtered.filter(p => p.marca === currentBrand);

        if (currentSearchTerm) {
            const term = currentSearchTerm.toLowerCase();
            filtered = filtered.filter(p =>
                p.nombre.toLowerCase().includes(term) ||
                (p.descripcion && p.descripcion.toLowerCase().includes(term)) ||
                (p.marca && p.marca.toLowerCase().includes(term))
            );
        }
        renderProducts(filtered);
    }

    function renderProducts(productos) {
        container.innerHTML = '';
        loadingOverlay.style.display = 'none';

        if (productos.length === 0) {
            container.innerHTML = `<div class="col-12 text-center text-muted mt-5"><h4>No se encontraron productos</h4></div>`;
            return;
        }

        productos.forEach(p => {
            let talla = p.tallaRopa || (p.tallaCalzado ? p.tallaCalzado : null);
            let tallaBadge = talla ? `<span class="badge-size">${talla}</span>` : '';
            
            let imgContent;
            if (p.imagenes && p.imagenes.length > 1) {
                let slides = p.imagenes.map((url, i) => `<div class="carousel-item ${i===0?'active':''} h-100"><img src="${url}" class="product-img" alt="${p.nombre}"></div>`).join('');
                imgContent = `<div id="car-${p._id}" class="carousel slide h-100" data-bs-interval="false"><div class="carousel-inner h-100">${slides}</div><button class="carousel-control-prev" type="button" data-bs-target="#car-${p._id}" data-bs-slide="prev"><span class="carousel-control-prev-icon"></span></button><button class="carousel-control-next" type="button" data-bs-target="#car-${p._id}" data-bs-slide="next"><span class="carousel-control-next-icon"></span></button></div>`;
            } else {
                imgContent = `<img src="${p.imagenUrl || 'https://placehold.co/300x300?text=No+Img'}" class="product-img" alt="${p.nombre}">`;
            }

            const col = document.createElement('div');
            col.className = 'col-6 col-md-4 col-lg-3'; 
            col.innerHTML = `
            <div class="product-card">
                <div class="img-container">${imgContent}</div>
                <div class="card-body-custom">
                    <div class="product-title">${p.nombre}</div>
                    <div class="badge-group">
                        <span class="badge-brand">${p.marca || 'GENÉRICO'}</span>
                        <span class="badge-gender">${p.genero === 'HOMBRE' ? 'HOMBRE' : (p.genero === 'MUJER' ? 'MUJER' : 'UNISEX')}</span>
                        ${tallaBadge}
                    </div>
                    ${p.esSegundaOportunidad ? '<div class="badge-second">2da OPORTUNIDAD</div>' : ''}
                    <p class="product-desc" title="Toca para ver más">${p.descripcion || 'Sin descripción'}</p>
                    <div class="product-price">${currencyMX(p.precio)}</div>
                    <div class="product-stock">${p.stock} disponibles</div>
                    <button class="btn-delete-full" data-id="${p._id}"><i class="bi bi-trash3 me-1"></i> Eliminar</button>
                </div>
            </div>`;
            container.appendChild(col);

            const cardBody = col.querySelector('.card-body-custom');
            const descElement = col.querySelector('.product-desc');
            cardBody.addEventListener('click', (e) => {
                if (e.target.closest('button') || e.target.closest('.carousel-control-prev') || e.target.closest('.carousel-control-next')) return;
                descElement.classList.toggle('expanded');
            });
        });

        document.querySelectorAll('.btn-delete-full').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.stopPropagation(); 
                const id = e.currentTarget.dataset.id;
                if(confirm('¿Eliminar producto permanentemente?')) {
                    e.currentTarget.closest('.col-6').style.opacity = '0.5';
                    await deleteDoc(doc(db, 'productos', id));
                }
            });
        });
    }

    // FORM LOGIC
    marcaSelect.addEventListener('change', function() {
        marcaManual.classList.toggle('d-none', this.value !== 'OTRO');
        if(this.value === 'OTRO') marcaManual.focus();
    });

    tipoProductoSelect.addEventListener('change', function() {
        const val = this.value;
        divTallaRopa.classList.add('d-none'); divTallaCalzado.classList.add('d-none'); mensajeSinTipo.classList.add('d-none');
        if(val === 'Calzado') divTallaCalzado.classList.remove('d-none');
        else if(['Playeras','Tops','Shorts','Sudaderas','Hoodies','Faldas','Leggins'].includes(val)) divTallaRopa.classList.remove('d-none');
        else mensajeSinTipo.classList.remove('d-none'); 
    });

    imagenesInput.addEventListener('change', function(e) {
        previewDiv.innerHTML = '';
        Array.from(e.target.files).forEach(file => {
            if(file.type.startsWith('image/')){
                const img = document.createElement('img'); img.src = URL.createObjectURL(file); img.className = 'thumb'; previewDiv.appendChild(img);
            }
        });
    });

    const q = query(collection(db, 'productos'), orderBy('createdAt', 'desc'));
    onSnapshot(q, (snapshot) => {
        allProducts = snapshot.docs.map(d => ({_id: d.id, ...d.data()}));
        updateBrandMenu(); applyFilters();
    }, (error) => { console.error(error); loadingOverlay.style.display = 'none'; });

    function currencyMX(n) { return Number(n).toLocaleString('es-MX', {style:'currency', currency:'MXN'}); }

    async function uploadImages(files) {
        const urls = [];
        for (const file of files) {
            const formData = new FormData(); formData.append("file", file); formData.append("upload_preset", uploadPreset);
            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {method: "POST", body: formData});
                const data = await res.json(); if(data.secure_url) urls.push(data.secure_url);
            } catch(e) { console.error(e); }
        }
        return urls;
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn'); const spin = document.getElementById('submitSpinner');
        btn.disabled = true; spin.classList.remove('d-none');

        try {
            const nombre = document.getElementById('nombreProducto').value.trim();
            const precio = parseFloat(document.getElementById('precioProducto').value);
            const stock = parseInt(document.getElementById('stock').value);
            const descripcion = document.getElementById('descripcion').value;
            const genero = document.getElementById('genero').value;
            let marca = marcaSelect.value === 'OTRO' ? marcaManual.value.toUpperCase() : marcaSelect.value;
            const tipo = tipoProductoSelect.value;
            let tallaRopa = (['Playeras','Tops','Shorts','Sudaderas','Hoodies','Faldas','Leggins'].includes(tipo)) ? document.getElementById('tallaRopa').value : null;
            let tallaCalzado = (tipo === 'Calzado') ? document.getElementById('tallaCalzado').value : null;
            const esSegunda = document.getElementById('esSegundaOportunidad').checked;
            
            let imgs = await uploadImages(imagenesInput.files);
            if(imgs.length === 0) imgs = ['https://placehold.co/400x400?text=Sin+Foto'];

            await addDoc(collection(db, 'productos'), {
                nombre, precio, stock, descripcion, genero, marca,
                tipoProducto: tipo, categoria: tipo,
                tallaRopa, tallaCalzado, esSegundaOportunidad: esSegunda,
                imagenes: imgs, imagenUrl: imgs[0], createdAt: serverTimestamp()
            });

            form.reset(); modal.hide(); previewDiv.innerHTML = '';
            marcaManual.classList.add('d-none'); divTallaRopa.classList.add('d-none'); divTallaCalzado.classList.add('d-none'); mensajeSinTipo.classList.remove('d-none');
        } catch (error) { alert("Error al guardar: " + error.message); } 
        finally { btn.disabled = false; spin.classList.add('d-none'); }
    });

    if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
  </script>
</body>
</html>